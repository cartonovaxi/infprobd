<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Free Fire EXP Live Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
    margin:0;
    font-family:Segoe UI, sans-serif;
    background:#020617;
    color:#e5e7eb;
}
.container{
    max-width:1200px;
    margin:auto;
    padding:20px;
}
h1{
    text-align:center;
    color:#38bdf8;
    margin-bottom:10px;
}
.subtitle{
    text-align:center;
    color:#94a3b8;
    margin-bottom:30px;
    font-size:14px;
}
.search{
    display:flex;
    justify-content:center;
    gap:10px;
    margin-bottom:20px;
}
input{
    padding:12px;
    width:260px;
    border-radius:8px;
    border:none;
    background:#1e293b;
    color:#e5e7eb;
}
button{
    padding:12px 20px;
    border:none;
    border-radius:8px;
    background:#38bdf8;
    color:white;
    cursor:pointer;
    font-size:16px;
    font-weight:bold;
    transition:0.3s;
}
button:hover{background:#0ea5e9; transform:translateY(-2px);}

.cards{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
    gap:15px;
    margin-bottom:20px;
}
.card{
    background:#1e293b;
    border-radius:12px;
    padding:15px;
    box-shadow:0 4px 12px rgba(0,0,0,.3);
    border-left:4px solid #38bdf8;
    transition:0.3s;
}
.card:hover{
    transform:translateY(-3px);
    box-shadow:0 6px 16px rgba(56,189,248,.2);
}
.card span{
    color:#38bdf8;
    font-weight:bold;
}
.card .value{
    font-size:18px;
    margin-top:5px;
}
.card .small-text{
    font-size:12px;
    color:#94a3b8;
    margin-top:3px;
}

/* Level Progress Card - Much Bigger and Advanced */
#levelProgressCard {
    grid-column: span 2;
    min-height: 220px;
    padding: 25px;
    background: linear-gradient(135deg, #1e293b, #0f172a);
    border-left: 4px solid #22c55e;
}
#levelProgressCard h3 {
    color:#22c55e;
    margin-top:0;
    margin-bottom:15px;
    font-size:20px;
    display:flex;
    align-items:center;
    gap:10px;
}
#levelProgressCard h3::before {
    content: "üìä";
    font-size:24px;
}
#levelProgressCard .progress-wrap {
    height: 35px;
    margin-top: 15px;
    margin-bottom: 20px;
    border-radius: 20px;
    overflow: hidden;
    background: #0f172a;
    box-shadow: inset 0 2px 10px rgba(0,0,0,0.5);
}
#levelProgressCard .progress {
    height:100%;
    width:0%;
    background:linear-gradient(90deg, #22c55e, #38bdf8, #8b5cf6);
    transition:.4s;
    border-radius:20px;
    position:relative;
    overflow:hidden;
}
#levelProgressCard .progress::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, 
        transparent 0%, 
        rgba(255,255,255,0.1) 50%, 
        transparent 100%);
    animation: shimmer 2s infinite;
}
@keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}
#levelProgressCard .progress-info {
    display: flex;
    justify-content: space-between;
    margin-bottom: 5px;
}
#levelProgressCard .progress-label {
    color: #94a3b8;
    font-size: 14px;
}
#levelProgressCard .progress-percent {
    color: #22c55e;
    font-weight: bold;
    font-size: 16px;
}
#levelProgressCard .exp-details {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
    margin-top: 20px;
}
#levelProgressCard .exp-detail-item {
    background: rgba(15, 23, 42, 0.5);
    padding: 12px;
    border-radius: 8px;
    border-left: 3px solid #38bdf8;
}
#levelProgressCard .exp-detail-label {
    color: #94a3b8;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 5px;
}
#levelProgressCard .exp-detail-value {
    color: #e5e7eb;
    font-size: 18px;
    font-weight: bold;
}
#levelProgressCard .exp-detail-sub {
    color: #22c55e;
    font-size: 12px;
    margin-top: 3px;
}

/* Mini Progress Bars for additional stats */
.mini-progress-container {
    margin-top: 15px;
}
.mini-progress {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
}
.mini-progress-label {
    width: 120px;
    color: #94a3b8;
    font-size: 12px;
}
.mini-progress-bar-container {
    flex: 1;
    height: 12px;
    background: #0f172a;
    border-radius: 6px;
    overflow: hidden;
    margin: 0 10px;
}
.mini-progress-bar {
    height: 100%;
    border-radius: 6px;
    transition: width 0.3s;
}
#expRateProgress {
    background: linear-gradient(90deg, #f59e0b, #fbbf24);
}
#timeProgress {
    background: linear-gradient(90deg, #8b5cf6, #a78bfa);
}
.mini-progress-value {
    width: 60px;
    color: #e5e7eb;
    font-size: 12px;
    font-weight: bold;
    text-align: right;
}

/* Target Level Card */
#targetLevelCard {
    grid-column: span 1;
    min-height: 220px;
    padding: 25px;
    background: linear-gradient(135deg, #1e293b, #0f172a);
    border-left: 4px solid #8b5cf6;
}
#targetLevelCard h3 {
    color:#8b5cf6;
    margin-top:0;
    margin-bottom:15px;
    font-size:20px;
    display:flex;
    align-items:center;
    gap:10px;
}
#targetLevelCard h3::before {
    content: "üéØ";
    font-size:24px;
}
#targetLevelCard .target-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: calc(100% - 40px);
}
#targetLevelCard .target-level-display {
    font-size: 60px;
    font-weight: bold;
    color: #8b5cf6;
    text-shadow: 0 0 20px rgba(139, 92, 246, 0.5);
    margin: 10px 0;
}
#targetLevelCard .target-label {
    color: #94a3b8;
    font-size: 14px;
    margin-bottom: 5px;
}
#targetLevelCard .current-to-target {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 15px 0;
}
#targetLevelCard .current-level {
    color: #38bdf8;
    font-size: 24px;
    font-weight: bold;
}
#targetLevelCard .arrow {
    color: #94a3b8;
    font-size: 20px;
}
#targetLevelCard .target-level {
    color: #8b5cf6;
    font-size: 24px;
    font-weight: bold;
}
#targetLevelCard .target-progress-wrap {
    width: 100%;
    height: 20px;
    background: #0f172a;
    border-radius: 10px;
    overflow: hidden;
    margin: 15px 0;
}
#targetLevelCard .target-progress {
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, #8b5cf6, #a78bfa);
    transition: .4s;
    border-radius: 10px;
}
#targetLevelCard .target-details {
    width: 100%;
    margin-top: 15px;
}
#targetLevelCard .target-detail-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    padding-bottom: 8px;
    border-bottom: 1px solid rgba(148, 163, 184, 0.2);
}
#targetLevelCard .target-detail-label {
    color: #94a3b8;
    font-size: 12px;
}
#targetLevelCard .target-detail-value {
    color: #e5e7eb;
    font-size: 14px;
    font-weight: bold;
}

.progress-wrap{
    margin-top:8px;
    background:#0f172a;
    border-radius:20px;
    overflow:hidden;
    height:20px;
}
.progress{
    height:100%;
    width:0%;
    background:linear-gradient(90deg,#22c55e,#38bdf8);
    transition:.4s;
    border-radius:20px;
}

.console{
    margin-top:20px;
    background:#0a101d;
    border-radius:12px;
    padding:15px;
    height:170px;
    overflow:auto;
    font-family:monospace;
    font-size:13px;
    border:1px solid #596374;
}

canvas{
    background:#0f172a;
    border-radius:12px;
    padding:15px;
    margin-top:20px;
    border:1px solid #374151;
}

.time-calc{
    background:linear-gradient(135deg,#1e293b,#0f172a);
    padding:15px;
    border-radius:12px;
    margin-top:15px;
    border-left:4px solid #10b981;
}
.time-calc h3{
    color:#10b981;
    margin-top:0;
}
.time-calc p{
    margin:8px 0;
}
.time-calc span{
    color:#fbbf24;
}

.notification{
    position:fixed;
    top:20px;
    right:20px;
    background:#ef4444;
    color:white;
    padding:15px;
    border-radius:8px;
    display:none;
    z-index:1000;
    box-shadow:0 4px 12px rgba(239,68,68,.3);
    animation:slideIn 0.3s ease;
}
@keyframes slideIn{
    from{transform:translateX(100%); opacity:0;}
    to{transform:translateX(0); opacity:1;}
}

.status-indicator{
    display:inline-block;
    width:10px;
    height:10px;
    border-radius:50%;
    margin-left:10px;
    background:#10b981;
    animation:pulse 2s infinite;
}
@keyframes pulse{
    0%{box-shadow:0 0 0 0 rgba(16,185,129,0.7);}
    70%{box-shadow:0 0 0 10px rgba(16,185,129,0);}
    100%{box-shadow:0 0 0 0 rgba(16,185,129,0);}
}

.warning{background:#f59e0b;}
.inactive{background:#ef4444;}

.player-info{
    background:linear-gradient(135deg,#1e293b,#0f172a);
    padding:15px;
    border-radius:12px;
    margin-bottom:20px;
    border-left:4px solid #8b5cf6;
    display:none;
}
.player-info h3{
    color:#8b5cf6;
    margin-top:0;
    margin-bottom:10px;
}
.player-details{
    display:flex;
    flex-wrap:wrap;
    gap:15px;
}
.player-detail-item{
    flex:1;
    min-width:150px;
}
.player-detail-item .label{
    color:#94a3b8;
    font-size:12px;
    text-transform:uppercase;
    letter-spacing:0.5px;
}
.player-detail-item .value{
    color:#e5e7eb;
    font-size:16px;
    font-weight:bold;
    margin-top:3px;
}
</style>
</head>

<body>
<div class="notification" id="notification">
    ‚ö†Ô∏è No EXP gained in last 10 minutes! Check your game connection.
</div>

<div class="container">
<h1>üî• Free Fire Level & EXP Live Tracker</h1>
<div class="subtitle">Real-time EXP tracking ‚Ä¢ Level prediction ‚Ä¢ Performance analytics</div>

<div class="player-info" id="playerInfo">
    <h3>üéÆ Player Information</h3>
    <div class="player-details">
        <div class="player-detail-item">
            <div class="label">Player Name</div>
            <div class="value" id="playerName">-</div>
        </div>
        <div class="player-detail-item">
            <div class="label">Guild Name</div>
            <div class="value" id="guildName">-</div>
        </div>
        <div class="player-detail-item">
            <div class="label">Account Age</div>
            <div class="value" id="accountAge">-</div>
        </div>
        <div class="player-detail-item">
            <div class="label">Last Login</div>
            <div class="value" id="lastLogin">-</div>
        </div>
    </div>
</div>

<div class="search">
    <input id="uid" placeholder="Enter Free Fire UID (e.g., 1234567890)">
    <button onclick="start()">Start Tracking <span id="status" class="status-indicator"></span></button>
</div>

<div class="cards">
    <div class="card">Player UID: <div class="value"><span id="name">-</span></div></div>
    <div class="card">Region: <div class="value"><span id="region">-</span></div></div>
    <div class="card">Current Level: <div class="value"><span id="level">-</span></div></div>
    <div class="card">Current EXP: <div class="value"><span id="exp">-</span></div></div>
    <div class="card">EXP Gained (Session): <div class="value"><span id="add">0</span></div></div>
    <div class="card">Next Level: <div class="value"><span id="next">-</span></div></div>
    <div class="card">EXP Needed: <div class="value"><span id="need">-</span></div></div>
    <div class="card">EXP Remaining: <div class="value"><span id="remain">-</span></div></div>
    <div class="card">Account Total EXP: <div class="value"><span id="total">-</span></div></div>
    
    <!-- New Card: Session EXP/minute -->
    <div class="card">
        Session EXP/minute
        <div class="value"><span id="expPerMin">0</span></div>
        <div class="small-text">Average gain per minute</div>
    </div>
    
    <!-- New Card: Session Time -->
    <div class="card">
        Session Time
        <div class="value"><span id="sessionTime">00:00:00</span></div>
        <div class="small-text" id="sessionTimeDetailed">0 days, 0 hours, 0 minutes, 0 seconds</div>
    </div>
    
    <!-- Level Progress Card (Bigger and Advanced) -->
    <div class="card" id="levelProgressCard">
        <h3>Level Progress Dashboard</h3>
        
        <div class="progress-info">
            <div class="progress-label">Level <span id="currentLevelDisplay">-</span> ‚Üí Level <span id="nextLevelDisplay">-</span></div>
            <div class="progress-percent" id="percent">0.000%</div>
        </div>
        
        <div class="progress-wrap">
            <div id="bar" class="progress"></div>
        </div>
        
        <div class="exp-details">
            <div class="exp-detail-item">
                <div class="exp-detail-label">Current EXP</div>
                <div class="exp-detail-value" id="currentExpDetailed">-</div>
                <div class="exp-detail-sub" id="currentExpSub">of level <span id="currentLevelSub">-</span></div>
            </div>
            
            <div class="exp-detail-item">
                <div class="exp-detail-label">EXP Remaining</div>
                <div class="exp-detail-value" id="remainingExpDetailed">-</div>
                <div class="exp-detail-sub">to Level <span id="nextLevelSub">-</span></div>
            </div>
            
            <div class="exp-detail-item">
                <div class="exp-detail-label">EXP Progress</div>
                <div class="exp-detail-value" id="expProgressDetailed">-/-</div>
                <div class="exp-detail-sub" id="expProgressSub">EXP completed</div>
            </div>
            
            <div class="exp-detail-item">
                <div class="exp-detail-label">Time Remaining</div>
                <div class="exp-detail-value" id="timeRemainingValue">-</div>
                <div class="exp-detail-sub" id="timeRemainingSub">to next level</div>
            </div>
        </div>
        
        <!-- Mini Progress Bars -->
        <div class="mini-progress-container">
            <div class="mini-progress">
                <div class="mini-progress-label">EXP Rate</div>
                <div class="mini-progress-bar-container">
                    <div id="expRateProgressBar" class="mini-progress-bar" style="width: 0%"></div>
                </div>
                <div class="mini-progress-value" id="expRateValue">0/min</div>
            </div>
            
            <div class="mini-progress">
                <div class="mini-progress-label">Time Progress</div>
                <div class="mini-progress-bar-container">
                    <div id="timeProgressBar" class="mini-progress-bar" style="width: 0%"></div>
                </div>
                <div class="mini-progress-value" id="timeProgressValue">0%</div>
            </div>
        </div>
    </div>
    
    <!-- Target Level Card (New Feature) -->
    <div class="card" id="targetLevelCard">
        <h3>Target Level</h3>
        
        <div class="target-content">
            <div class="target-label">Your Current Target</div>
            <div class="target-level-display" id="targetLevelDisplay">-</div>
            
            <div class="current-to-target">
                <div class="current-level" id="targetCurrentLevel">-</div>
                <div class="arrow">‚Üí</div>
                <div class="target-level" id="targetGoalLevel">-</div>
            </div>
            
            <div class="target-progress-wrap">
                <div id="targetProgressBar" class="target-progress"></div>
            </div>
            
            <div class="target-details">
                <div class="target-detail-item">
                    <div class="target-detail-label">Target EXP Needed</div>
                    <div class="target-detail-value" id="targetExpNeeded">-</div>
                </div>
                <div class="target-detail-item">
                    <div class="target-detail-label">Current to Target</div>
                    <div class="target-detail-value" id="currentToTarget">-</div>
                </div>
                <div class="target-detail-item">
                    <div class="target-detail-label">Target Time</div>
                    <div class="target-detail-value" id="targetTime">-</div>
                </div>
                <div class="target-detail-item">
                    <div class="target-detail-label">Target Progress</div>
                    <div class="target-detail-value" id="targetProgressPercent">0%</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="time-calc">
    <h3>‚è±Ô∏è Level Time Estimation</h3>
    <p>Time to next level: <span id="timeToNextDetailed">Calculating...</span></p>
    <p>Current EXP rate: <span id="expRate">0</span> EXP/minute</p>
    <p>Estimated level completion: <span id="estCompletion">-</span></p>
    <p>Detailed breakdown: <span id="timeBreakdown">- days, - hours, - minutes, - seconds</span></p>
</div>

<canvas id="chart" height="140"></canvas>
<div class="console" id="log"></div>

</div>

<script>
// ---------------- FULL EXP TABLE ----------------
const EXP = {
1:[0,48],2:[48,154],3:[202,342],4:[544,468],5:[1012,832],6:[1844,948],
7:[2792,1008],8:[3800,1070],9:[4870,1134],10:[6004,1188],
11:[7192,1256],12:[8448,1328],13:[9776,1364],14:[11140,1426],
15:[12566,1494],16:[14060,1550],17:[15610,1614],18:[17224,1678],
19:[18902,1730],20:[20632,1792],21:[22424,2304],22:[24728,1464],
23:[26192,1974],24:[28166,2034],25:[30200,2094],26:[32294,2154],
27:[34448,3356],28:[37804,3370],29:[41174,3696],30:[44870,3982],
31:[48852,4482],32:[53334,5232],33:[58566,5530],34:[64096,5898],
35:[69994,6466],36:[76460,6648],37:[83108,8020],38:[91128,8194],
39:[99322,8770],40:[108092,12052],41:[120144,13122],42:[133266,14206],
43:[147472,15288],44:[162760,16366],45:[179126,17446],46:[196572,18796],
47:[215368,20148],48:[235516,21494],49:[257010,22850],50:[279860,24196],
51:[304056,44262],52:[348318,46664],53:[394982,49062],54:[444044,51464],
55:[495508,53856],56:[549364,84392],57:[633756,87988],58:[721744,91592],
59:[813336,95186],60:[908522,132916],61:[1041438,138914],
62:[1180352,144904],63:[1325256,150928],64:[1476184,158116],
65:[1634300,206646],66:[1840946,215648],67:[2056594,224648],
68:[2281242,233638],69:[2514880,242650],70:[2757530,301976],
71:[3059506,312778],72:[3372284,327172],73:[3699456,341574],
74:[4041030,355990],75:[4397020,432084],76:[4829104,453100],
77:[5282204,474100],78:[5756304,495100],79:[6251404,516100],
80:[6767504,613820],81:[7381324,661830],82:[8043154,709798],
83:[8752952,757856],84:[9510808,804830],85:[10316638,960552],
86:[11277190,1083558],87:[12360748,999556],88:[13360304,1122554],
89:[14482858,1170560],90:[15659418,1367290],91:[17026708,1426980],
92:[18453688,1488592],93:[19941280,1546280],94:[21488570,1606288],
95:[23095858,1665280],96:[24763138,1722000],97:[26490138,1787570],
98:[28277708,1847288],99:[30124996,1907288],100:[32032284,0]
};

// ---------------- TARGET LEVEL CALCULATION ----------------
function calculateTargetLevel(currentLevel) {
    if (currentLevel >= 1 && currentLevel <= 9) return 10;
    if (currentLevel >= 11 && currentLevel <= 19) return 20;
    if (currentLevel >= 21 && currentLevel <= 29) return 30;
    if (currentLevel >= 31 && currentLevel <= 39) return 40;
    if (currentLevel >= 41 && currentLevel <= 49) return 50;
    if (currentLevel >= 51 && currentLevel <= 59) return 60;
    if (currentLevel >= 61 && currentLevel <= 69) return 70;
    if (currentLevel >= 71 && currentLevel <= 79) return 80; 
    if (currentLevel >= 81 && currentLevel <= 89) return 90;
    if (currentLevel >= 91 && currentLevel <= 99) return 100;
    
    // If already at max level or beyond
    if (currentLevel >= 100) return 100;
    
    // Default fallback
    return Math.ceil(currentLevel / 10) * 10;
}

// ---------------- GLOBAL VARIABLES ----------------
let lastExp = null;
let lastLevel = null;
let uid = null;
let timer = null;
let chart;
let lastGainTime = null;
let expHistory = [];
let expTimestamps = [];
let sessionStartTime = null;
let totalSessionGain = 0;
let sessionTimer = null;
let sessionSeconds = 0;

// ---------------- FORMAT TIME FUNCTIONS ----------------
function formatTimeDetailed(seconds) {
    const days = Math.floor(seconds / 86400);
    const hours = Math.floor((seconds % 86400) / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = Math.floor(seconds % 60);
    
    let result = [];
    if (days > 0) result.push(`${days} DAYS`);
    if (hours > 0) result.push(`${hours} HOURS`);
    if (minutes > 0) result.push(`${minutes} MINUTES`);
    if (secs > 0 || result.length === 0) result.push(`${secs} SECONDS`);
    
    return result.join(", ");
}

function formatTimeShort(seconds) {
    if (seconds >= 86400) {
        const days = Math.floor(seconds / 86400);
        const hours = Math.floor((seconds % 86400) / 3600);
        return `${days}d ${hours}h`;
    } else if (seconds >= 3600) {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        return `${hours}h ${minutes}m`;
    } else if (seconds >= 60) {
        const minutes = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${minutes}m ${secs}s`;
    } else {
        return `${Math.floor(seconds)}s`;
    }
}

function formatTimeDigital(seconds) {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = Math.floor(seconds % 60);
    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
}

// ---------------- NOTIFICATION ----------------
function showNotification(message, type = "warning") {
    const notif = document.getElementById("notification");
    notif.textContent = message;
    notif.style.background = type === "warning" ? "#f59e0b" : "#ef4444";
    notif.style.display = "block";
    
    // Play sound
    const audio = new Audio("https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3");
    audio.volume = 0.3;
    audio.play().catch(e => console.log("Audio error:", e));
    
    setTimeout(() => {
        notif.style.display = "none";
    }, 5000);
}

// ---------------- LOG ----------------
function log(t) {
    const l = document.getElementById("log");
    l.innerHTML += `[${new Date().toLocaleTimeString()}] ${t}<br>`;
    l.scrollTop = l.scrollHeight;
}

// ---------------- CHART ----------------
function initChart() {
    chart = new Chart(document.getElementById("chart"), {
        type: "line",
        data: {
            labels: [],
            datasets: [
                {
                    label: "EXP Gain Per Minute",
                    data: [],
                    borderColor: "#38bdf8",
                    backgroundColor: "rgba(56, 189, 248, 0.2)",
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    labels: { color: "#e5e7eb" }
                },
                tooltip: {
                    backgroundColor: "rgba(30, 41, 59, 0.9)",
                    titleColor: "#e5e7eb",
                    bodyColor: "#38bdf8"
                }
            },
            scales: {
                x: {
                    grid: { color: "#374151" },
                    ticks: { color: "#9ca3af" }
                },
                y: {
                    grid: { color: "#374151" },
                    ticks: { color: "#9ca3af" },
                    title: {
                        display: true,
                        text: "EXP",
                        color: "#94a3b8"
                    }
                }
            }
        }
    });
}

// ---------------- CALCULATE LEVEL FROM EXP ----------------
function calculateLevelFromExp(exp) {
    let level = 1;
    for (let lvl in EXP) {
        if (exp >= EXP[lvl][0]) {
            level = parseInt(lvl);
        } else {
            break;
        }
    }
    return level;
}

// ---------------- TIME CALCULATION ----------------
function calculateTimeToNextLevel(exp, expRate) {
    if (!expRate || expRate <= 0) return { totalSeconds: 0, formatted: "N/A", detailed: "N/A" };
    
    const level = calculateLevelFromExp(exp);
    const base = EXP[level]?.[0] || 0;
    const need = EXP[level]?.[1] || 0;
    const remaining = Math.max(0, need - (exp - base));
    
    const totalSeconds = Math.ceil((remaining / expRate) * 60);
    
    return {
        totalSeconds: totalSeconds,
        formatted: formatTimeShort(totalSeconds),
        detailed: formatTimeDetailed(totalSeconds)
    };
}

// ---------------- TARGET LEVEL CALCULATIONS ----------------
function calculateTargetLevelInfo(currentLevel, currentExp, expRate) {
    const targetLevel = calculateTargetLevel(currentLevel);
    
    // If already at or above target level
    if (currentLevel >= targetLevel) {
        return {
            targetLevel: targetLevel,
            targetExpNeeded: 0,
            currentToTargetExp: 0,
            targetProgressPercent: 100,
            targetTime: 0,
            targetTimeFormatted: "üéâ Target Achieved!"
        };
    }
    
    // Calculate total EXP needed for target level
    let totalExpToTarget = 0;
    let currentExpInLevel = currentExp;
    
    // Sum EXP needed from current level to target level
    for (let lvl = currentLevel; lvl < targetLevel; lvl++) {
        if (EXP[lvl] && EXP[lvl][1]) {
            totalExpToTarget += EXP[lvl][1];
        }
    }
    
    // Subtract EXP already earned in current level
    const currentLevelBase = EXP[currentLevel]?.[0] || 0;
    const expEarnedInCurrentLevel = currentExp - currentLevelBase;
    const remainingExpToTarget = Math.max(0, totalExpToTarget - expEarnedInCurrentLevel);
    
    // Calculate progress percentage
    const targetProgressPercent = ((totalExpToTarget - remainingExpToTarget) / totalExpToTarget) * 100;
    
    // Calculate time to target
    let targetTime = 0;
    let targetTimeFormatted = "N/A";
    
    if (expRate > 0) {
        targetTime = Math.ceil((remainingExpToTarget / expRate) * 60); // Convert to seconds
        targetTimeFormatted = formatTimeShort(targetTime);
    }
    
    return {
        targetLevel: targetLevel,
        targetExpNeeded: totalExpToTarget,
        currentToTargetExp: remainingExpToTarget,
        targetProgressPercent: targetProgressPercent,
        targetTime: targetTime,
        targetTimeFormatted: targetTimeFormatted
    };
}

// ---------------- EXP RATE CALCULATION ----------------
function calculateExpRate() {
    if (expHistory.length < 2) return 0;
    
    let totalExp = 0;
    let totalTime = 0;
    
    for (let i = 1; i < expHistory.length; i++) {
        const expDiff = expHistory[i] - expHistory[i-1];
        const timeDiff = (expTimestamps[i] - expTimestamps[i-1]) / 60000; // Convert to minutes
        if (timeDiff > 0) {
            totalExp += expDiff;
            totalTime += timeDiff;
        }
    }
    
    return totalTime > 0 ? (totalExp / totalTime) : 0;
}

// ---------------- UPDATE PLAYER INFO ----------------
function updatePlayerInfo(playerData) {
    const playerInfoDiv = document.getElementById("playerInfo");
    
    if (playerData) {
        playerInfoDiv.style.display = "block";
        
        // Update player name
        if (playerData.nickname) {
            document.getElementById("playerName").textContent = playerData.nickname;
        } else if (playerData.name) {
            document.getElementById("playerName").textContent = playerData.name;
        } else {
            document.getElementById("playerName").textContent = "Unknown";
        }
        
        // Update guild name (clanName in API)
        if (playerData.clanName) {
            document.getElementById("guildName").textContent = playerData.clanName;
        } else {
            document.getElementById("guildName").textContent = "No Guild";
        }
        
        // Update account age from createAt timestamp
        if (playerData.createAt) {
            const createTimestamp = parseInt(playerData.createAt);
            if (!isNaN(createTimestamp) && createTimestamp > 0) {
                const createDate = new Date(createTimestamp * 1000);
                const now = new Date();
                const diffTime = Math.abs(now - createDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                document.getElementById("accountAge").textContent = `${diffDays} days`;
            } else {
                document.getElementById("accountAge").textContent = "-";
            }
        } else {
            document.getElementById("accountAge").textContent = "-";
        }
        
        // Update last login from lastLoginAt timestamp
        if (playerData.lastLoginAt) {
            const loginTimestamp = parseInt(playerData.lastLoginAt);
            if (!isNaN(loginTimestamp) && loginTimestamp > 0) {
                const loginDate = new Date(loginTimestamp * 1000);
                const now = new Date();
                const diffTime = Math.abs(now - loginDate);
                const diffMinutes = Math.floor(diffTime / (1000 * 60));
                
                if (diffMinutes < 60) {
                    document.getElementById("lastLogin").textContent = `${diffMinutes} minutes ago`;
                } else if (diffMinutes < 1440) {
                    const diffHours = Math.floor(diffMinutes / 60);
                    document.getElementById("lastLogin").textContent = `${diffHours} hours ago`;
                } else {
                    const diffDays = Math.floor(diffMinutes / 1440);
                    document.getElementById("lastLogin").textContent = `${diffDays} days ago`;
                }
            } else {
                document.getElementById("lastLogin").textContent = "-";
            }
        } else {
            document.getElementById("lastLogin").textContent = "-";
        }
    } else {
        playerInfoDiv.style.display = "none";
    }
}

// ---------------- UPDATE SESSION TIMER ----------------
function updateSessionTimer() {
    if (sessionStartTime) {
        sessionSeconds = Math.floor((Date.now() - sessionStartTime) / 1000);
        document.getElementById("sessionTime").textContent = formatTimeDigital(sessionSeconds);
        document.getElementById("sessionTimeDetailed").textContent = formatTimeDetailed(sessionSeconds);
    }
}

// ---------------- CALCULATE EXP PER MINUTE ----------------
function calculateExpPerMinute() {
    if (sessionSeconds === 0 || totalSessionGain === 0) return 0;
    const minutes = sessionSeconds / 60;
    return totalSessionGain / minutes;
}

// ---------------- UPDATE ADVANCED PROGRESS DISPLAY ----------------
function updateAdvancedProgressDisplay(exp, level, expRate, percent, cur, need, remaining, timeData) {
    // Update level displays
    document.getElementById("currentLevelDisplay").textContent = level;
    document.getElementById("nextLevelDisplay").textContent = level + 1;
    document.getElementById("currentLevelSub").textContent = level;
    document.getElementById("nextLevelSub").textContent = level + 1;
    
    // Update EXP values
    document.getElementById("currentExpDetailed").textContent = cur.toLocaleString();
    document.getElementById("remainingExpDetailed").textContent = remaining.toLocaleString();
    document.getElementById("expProgressDetailed").textContent = `${cur.toLocaleString()}/${need.toLocaleString()}`;
    document.getElementById("expProgressSub").textContent = `EXP completed (${percent.toFixed(2)}%)`;
    
    // Update time remaining
    document.getElementById("timeRemainingValue").textContent = timeData.formatted;
    document.getElementById("timeRemainingSub").textContent = `to Level ${level + 1}`;
    
    // Update percentage
    document.getElementById("percent").textContent = percent.toFixed(3) + "%";
    
    // Update mini progress bars
    const expRateNormalized = Math.min(100, (expRate / 1000) * 100); // Assuming max 1000 EXP/min
    document.getElementById("expRateProgressBar").style.width = expRateNormalized + "%";
    document.getElementById("expRateValue").textContent = expRate.toFixed(1) + "/min";
    
    // Time progress (inverse - as time passes, progress increases)
    const timeProgressPercent = Math.min(100, (percent)); // Same as level progress
    document.getElementById("timeProgressBar").style.width = timeProgressPercent + "%";
    document.getElementById("timeProgressValue").textContent = percent.toFixed(1) + "%";
}

// ---------------- UPDATE TARGET LEVEL DISPLAY ----------------
function updateTargetLevelDisplay(exp, level, expRate) {
    const targetInfo = calculateTargetLevelInfo(level, exp, expRate);
    
    // Update target level display
    document.getElementById("targetLevelDisplay").textContent = targetInfo.targetLevel;
    document.getElementById("targetCurrentLevel").textContent = level;
    document.getElementById("targetGoalLevel").textContent = targetInfo.targetLevel;
    
    // Update progress bar
    document.getElementById("targetProgressBar").style.width = targetInfo.targetProgressPercent + "%";
    
    // Update details
    document.getElementById("targetExpNeeded").textContent = targetInfo.targetExpNeeded.toLocaleString();
    document.getElementById("currentToTarget").textContent = targetInfo.currentToTargetExp.toLocaleString() + " EXP";
    document.getElementById("targetTime").textContent = targetInfo.targetTimeFormatted;
    document.getElementById("targetProgressPercent").textContent = targetInfo.targetProgressPercent.toFixed(1) + "%";
    
    // Log target achievement
    if (level >= targetInfo.targetLevel && lastLevel < targetInfo.targetLevel) {
        log(`üéØ TARGET ACHIEVED! Level ${targetInfo.targetLevel} reached!`);
        showNotification(`üéØ Congratulations! Target Level ${targetInfo.targetLevel} achieved!`, "warning");
    }
}

// ---------------- START TRACKING ----------------
function start() {
    uid = document.getElementById("uid").value.trim();
    if (!uid) return alert("Please enter a valid Free Fire UID");
    
    if (timer) clearInterval(timer);
    if (sessionTimer) clearInterval(sessionTimer);
    
    // Reset session data
    lastGainTime = Date.now();
    expHistory = [];
    expTimestamps = [];
    sessionStartTime = Date.now();
    totalSessionGain = 0;
    sessionSeconds = 0;
    
    // Update UI
    const statusIndicator = document.getElementById("status");
    statusIndicator.className = "status-indicator";
    
    log("üöÄ Tracking started for UID: " + uid);
    log("Session started at: " + new Date().toLocaleTimeString());
    
    // Start session timer
    sessionTimer = setInterval(updateSessionTimer, 1000);
    
    // Initial fetch
    fetchData();
    
    // Set interval for updates
    timer = setInterval(fetchData, 60000); // Every 60 seconds
    
    // Check for inactivity every 10 minutes
    setInterval(checkInactivity, 600000); // 10 minutes
}

// ---------------- CHECK INACTIVITY ----------------
function checkInactivity() {
    if (!lastGainTime) return;
    
    const now = Date.now();
    const minutesSinceLastGain = (now - lastGainTime) / 60000;
    
    if (minutesSinceLastGain >= 10) {
        showNotification("‚ö†Ô∏è No EXP gained in last 10 minutes! Check your game connection.", "warning");
        log("‚ö†Ô∏è No EXP gain detected for 10 minutes");
        
        // Update status indicator
        const statusIndicator = document.getElementById("status");
        statusIndicator.className = "status-indicator warning";
    }
}

// ---------------- FETCH DATA ----------------
async function fetchData() {
    try {
        const r = await fetch(`https://danger-info-alpha.vercel.app/accinfo?uid=${uid}&key=DANGERxINFO`);
        const d = await r.json();
        
        // API Error check
        if (d.error) {
            log("API Error: " + d.error);
            
            // Update status indicator
            const statusIndicator = document.getElementById("status");
            statusIndicator.className = "status-indicator inactive";
            return;
        }
        
        const info = d.basicInfo;
        if (!info) {
            log("Invalid API response - no basicInfo found");
            return;
        }

        const exp = parseInt(info.exp) || 0;
        const level = calculateLevelFromExp(exp);
        
        // Update player information
        updatePlayerInfo(info);
        
        // Update status indicator
        const statusIndicator = document.getElementById("status");
        statusIndicator.className = "status-indicator";
        
        // UI Update
        document.getElementById("name").innerText = info.accountId || uid;
        
        // Update region from API response
        if (info.region) {
            document.getElementById("region").innerText = info.region;
        } else if (info.accountRegion) {
            document.getElementById("region").innerText = info.accountRegion;
        } else {
            document.getElementById("region").innerText = "Unknown";
        }
        
        document.getElementById("level").innerText = level;
        document.getElementById("exp").innerText = exp.toLocaleString();
        document.getElementById("total").innerText = exp.toLocaleString();

        // Track EXP gain
        if (lastExp !== null) {
            let gained = exp - lastExp;
            if (gained > 0) {
                totalSessionGain += gained;
                lastGainTime = Date.now(); // Update last gain time
                
                document.getElementById("add").innerText = totalSessionGain.toLocaleString();
                
                // Add to chart
                const currentTime = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                chart.data.labels.push(currentTime);
                chart.data.datasets[0].data.push(gained);
                if (chart.data.labels.length > 20) {
                    chart.data.labels.shift();
                    chart.data.datasets[0].data.shift();
                }
                chart.update();
                
                log(`üìà EXP +${gained.toLocaleString()} (Total session: ${totalSessionGain.toLocaleString()})`);
                
                // Store for rate calculation
                expHistory.push(exp);
                expTimestamps.push(Date.now());
                
                // Keep only last 10 entries for rate calculation
                if (expHistory.length > 10) {
                    expHistory.shift();
                    expTimestamps.shift();
                }
            }
        } else {
            // First fetch
            expHistory.push(exp);
            expTimestamps.push(Date.now());
        }

        // Level up check
        if (lastLevel !== null && level > lastLevel) {
            log(`üéâ LEVEL UP! ${lastLevel} ‚Üí ${level}`);
            showNotification(`üéâ Congratulations! Level ${level} reached!`, "warning");
        }

        lastExp = exp;
        lastLevel = level;

        // Progress bar calculation
        const base = EXP[level]?.[0] || 0;
        const need = EXP[level]?.[1] || 0;
        const cur = exp - base;
        const percent = need ? Math.min(100, (cur / need) * 100) : 100;

        document.getElementById("need").innerText = need.toLocaleString();
        
        const remainingExp = Math.max(0, need - cur);
        document.getElementById("remain").innerText = remainingExp.toLocaleString();
        document.getElementById("next").innerText = level + 1;
        document.getElementById("bar").style.width = percent + "%";
        
        // Time calculation
        const expRate = calculateExpRate();
        document.getElementById("expRate").innerText = expRate.toFixed(1);
        
        // Update EXP per minute
        const expPerMin = calculateExpPerMinute();
        document.getElementById("expPerMin").innerText = expPerMin.toFixed(1);
        
        const timeData = calculateTimeToNextLevel(exp, expRate);
        
        // Update advanced progress display
        updateAdvancedProgressDisplay(exp, level, expRate, percent, cur, need, remainingExp, timeData);
        
        // Update target level display
        updateTargetLevelDisplay(exp, level, expRate);
        
        // Update detailed time display
        document.getElementById("timeToNextDetailed").innerText = timeData.formatted;
        document.getElementById("timeBreakdown").innerText = timeData.detailed;
        
        if (expRate > 0) {
            const completionTime = new Date(Date.now() + timeData.totalSeconds * 1000);
            document.getElementById("estCompletion").innerText = completionTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        } else {
            document.getElementById("estCompletion").innerText = "N/A";
        }

    } catch (e) {
        log("‚ùå API Error / Network issue");
        console.error(e);
        
        // Update status indicator
        const statusIndicator = document.getElementById("status");
        statusIndicator.className = "status-indicator inactive";
    }
}

// ---------------- PAGE LOAD ----------------
window.onload = function() {
    initChart();
    log("‚úÖ System Ready. Enter Free Fire UID to start tracking.");
    log("üìä Features: Real-time tracking ‚Ä¢ Level time estimation ‚Ä¢ Session timer ‚Ä¢ Target Level Tracker ‚Ä¢ Inactivity alerts");
};
</script>
</body>
</html>